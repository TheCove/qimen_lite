<!DOCTYPE html>
<html>
  <head>
    <title>大奇門遁甲(Original/founded by Goran FU Chi Leung)</title>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script language="JavaScript" src="_js/sprintf.min.js"></script>
    <style type="text/css">
    body  {position: relative;padding:0;margin:0}
    div   {position: relative}
    table {position: relative}
    form  {position: relative}
    tr    {position: relative;height: 7mm}
    td    {position: relative;padding:0}
    input, select {position: relative;top:0;left:0;right:0;bottom:0;width:100%;height:100%;border:0;padding:0}
    </style>
    <script language="javascript" src="_js/jquery.min.js"></script>
    <script language="javascript" src="_js/jiqi.js"></script>
    <script language="JavaScript" src="_js/lunar.js"></script>
    <script language="JavaScript" src="_js/qimen_min.js"></script>
    <script language="javascript">
    "use strict";
    var gbl_date = new Date();
    String.prototype.replaceAt=function(index, character) {
      return this.substr(0, index) + character + this.substr(index+character.length);
    };
    function gui_check_input_date(id) {
      "use strict";
      var patt1=/^[0-9]{4}[0-9]{2}[0-9]{2}-[0-9]{2}[0-9]{2}[0-9]{2}$/i;
      if(!id.match(patt1)) {
        return false;
      }
      var daysInMonth = [0,31,28,31,30,31,30,31,31,30,31,30,31];
      // If evenly divisible by 4 and not evenly divisible by 100,
      // or is evenly divisible by 400, then a leap year
      var y = (id.substr(0,4))*1;
      var m = (id.substr(4,2))*1;
      var d = (id.substr(6,2))*1;
      var h = (id.substr(9,2))*1;
      var i = (id.substr(11,2))*1;
      var s = (id.substr(13,2))*1;
      //console.log(y,m,d,h,i,s);
      if ( (!(y % 4) && y % 100) || !(y % 400)) {
        daysInMonth[2] = 29;
      }
      if(m < 1 || m > 12) return false;
      if(d < 1 || d > daysInMonth[m]) return false;
      if(h < 0 || h > 23) return false;
      if(i < 0 || i > 59) return false;
      if(s < 0 || s > 59) return false;
      return true;
    }
    function calc(){
      var id = $('input[name=txtDate]').val();
      if(gui_check_input_date(id) == false){
        alert('error format'); return;
      }
      var y = (id.substr(0,4))*1;
      var m = (id.substr(4,2))*1;
      var d = (id.substr(6,2))*1;
      var h = (id.substr(9,2))*1;
      var i = (id.substr(11,2))*1;
      var s = (id.substr(13,2))*1;
      gbl_date = new Date(y,m-1,d,h,i,s);
      // cal qimen;
      calc_qimen();
    }
    function calc_now() {
      gbl_date = null;
      gbl_date = new Date();
      calc_qimen();
    }
    function tuneDate(btn){
      var intxt = $(btn).val();
      var act = intxt[0];
      var idx = "年月日時分秒".indexOf(intxt[1]);
      if(!gbl_date) return;
      //
      if(act == '+') {
        if(idx == 0) { gbl_date.setDate(gbl_date.getDate() + 365);; }
        if(idx == 1) { gbl_date.setDate(gbl_date.getDate() + 30);; }
        if(idx == 2) { gbl_date.setDate(gbl_date.getDate() + 1);; }
        if(idx == 3) { gbl_date.setTime(gbl_date.getTime() + 3600000);; }
        if(idx == 4) { gbl_date.setTime(gbl_date.getTime() + 60000);; }
        if(idx == 5) { gbl_date.setTime(gbl_date.getTime() + 1000);; }
      } else {
        if(idx == 0) { gbl_date.setDate(gbl_date.getDate() - 365);; }
        if(idx == 1) { gbl_date.setDate(gbl_date.getDate() - 30);; }
        if(idx == 2) { gbl_date.setDate(gbl_date.getDate() - 1);; }
        if(idx == 3) { gbl_date.setTime(gbl_date.getTime() - 3600000);; }
        if(idx == 4) { gbl_date.setTime(gbl_date.getTime() - 60000);; }
        if(idx == 5) { gbl_date.setTime(gbl_date.getTime() - 1000);; }
      }
      calc_qimen();
    }
    function calc_qimen() {
      var d = new Date(gbl_date);
      var jiqi = QIMEN_STAR.jiqi.GetJiqiInfo(
        d.getFullYear(),d.getMonth()+1,d.getDate(),d.getHours(),d.getMinutes(),d.getSeconds());
      //console.log(jiqi);
      var out  = sprintf("%s\r\n",QIMEN_STAR.jiqi.JTime(jiqi.julian));
          out += sprintf("%s\r\n",QIMEN_STAR.Solar2Lunar(d.getFullYear(),d.getMonth()+1,d.getDate(),d.getHours(),d.getMinutes(),d.getSeconds()));      
          var cjiqi = jiqi.currentJiqiIdx - 1; if(cjiqi < 0) cjiqi = 23;
          out += sprintf("當前節氣: %s, %s\r\n",jiqi.jiqi[cjiqi],QIMEN_STAR.jiqi.JTime(jiqi.wholeYear[cjiqi]));
      // 排四柱
      var tcol0 = new Array;
      var dcol0 = new Array;
      for(var i = 6; i > -1 ; i -= 2) tcol0.push(jiqi.bazi[i]);
      for(var i = 7; i > -1 ; i -= 2) dcol0.push(jiqi.bazi[i]);
      //
      // 計時家奇門三元
      var idx1 =  "甲乙丙丁戊己庚辛壬癸".indexOf(jiqi.bazi[4]);
      var idx2 = "子丑寅卯辰巳午未申酉戌亥".indexOf(jiqi.bazi[5]);
      idx2 = idx2 - idx1 % 5;
      if(idx2 < 0) idx2 += 12;
      idx2 = idx2 % 3;
      if(idx2 > 0) {
        idx2 = (idx2 == 1)? 2 : 1;
      }
      out += jiqi.jiqi[cjiqi]+"上中下".charAt(idx2)+"元　";
      // 計算當前局數
      // 計陰陽遁
      var dun_type = 2; // 0為陰遁, 1為陽遁, 其餘為錯誤
      var kook = [8,9,1,3,4,5,4,5,6,9,8,7,2,1,9,7,6,5,6,5,4,1,2,3]; // 局數
      var using_kook = kook[cjiqi];  //局數
      //console.log(jtoday, jqTime[21], jqTime[9]);
      if( jiqi.julian > jiqi.wholeYear[9] && jiqi.julian < jiqi.wholeYear[21]) {
        // 陰遁
        dun_type = 0;
        for(var i = 0; i < idx2; i++) {
          using_kook -= 6;
          while(using_kook < 1) using_kook += 9;
        }
      } else {
        // 陽遁
        dun_type = 1;
        for(var i = 0; i < idx2; i++) {
          using_kook += 6;
          while(using_kook > 9) using_kook -= 9;
        }
      }
      if($('#cboDun').val() < 2) dun_type = $('#cboDun').val();
      if($('#cboKook').val() > 0) using_kook = $('#cboKook').val();
      //console.log("using_kook",using_kook);
      out += "陰陽".charAt(dun_type)+"遁"+" 一二三四五六七八九".charAt(using_kook)+"局"+"\r\n";
      // 輸出柱名
      out += "　　　";
      for(var i = 0; i < jiqi.bazi.length; i+=2) {
        out += "　"+"　年　月　日　時　分　秒毫秒不知未明疑問".substr(i,2);
      } out += "\r\n";
      // 輸出八字
      out += ("八字：");
      for(var i = 0; i < jiqi.bazi.length; i += 2) out+=("　"+jiqi.bazi.substr(i, 2));
      out+=("\r\n");
      // 計空亡
      out += ("空亡：");
      for(var i = 0; i < jiqi.bazi.length; i+=2) {
        var chun_sau = "子丑寅卯辰巳午未申酉戌亥".indexOf(jiqi.bazi[i+1]) - "甲乙丙丁戊己庚辛壬癸".indexOf(jiqi.bazi[i]);
        if(chun_sau < 0) chun_sau += 12;
        var hung_mon = chun_sau - 2;
        if(hung_mon < 0) hung_mon += 12;
        out += ("　"+"子丑寅卯辰巳午未申酉戌亥".substr(hung_mon, 2));
      }
       out += ("\r\n");
       
      // ---
      // 計算時家奇門遁甲
      // ---
      
      //var q1 = QIMEN_STAR.qimenCalc(dun_type,using_kook,jiqi.bazi.substr(6,2));
      //out += sprintf("值符：天%s\r\n", q1['info']['符']);
      // setup info 
      $('#info').html(out);
      //
      // var qq = new Array;
      // for(var i = 1; i < 10; i++) qq[i] = QIMEN_STAR.qimenCalc(dun_type,i,jiqi.bazi.substr(6,2));
      var gon = " 987654321987654321987654321".indexOf(using_kook,5);console.log('gon',gon);
      var gon = " 987654321987654321987654321".substring(gon-5,gon+5);
      console.log('gon',gon);
      for(var jj = 1; jj < 10; jj++) {
        var ot = $('#tpltable').text().split("\n");
        var qq = QIMEN_STAR.qimenCalc(dun_type,gon[jj],jiqi.bazi.substr(6,2));
        for(var i = 0; i < 9; i++) {
          var idx = [[12,7],[2,12],[7,2],[2,2],[7,7],[12,12],[7,12],[12,2],[2,7]];
          var sy = idx[i][0], sx = idx[i][1];
          // 時家奇門
          ot[sy+0] = ot[sy+0].replaceAt(sx+0,qq['門'][i+1]);
          ot[sy+0] = ot[sy+0].replaceAt(sx+1,qq['神'][i+1]);
          ot[sy+0] = ot[sy+0].replaceAt(sx+2,qq['天'][i+1]);
          ot[sy+1] = ot[sy+1].replaceAt(sx+1,qq['星'][i+1]);
          ot[sy+1] = ot[sy+1].replaceAt(sx+2,qq['地'][i+1]);
        }
        $('#ii'+jj).html(ot.join("\n")).css('font-size','3mm');
      }
    }
    $(document).ready(calc_qimen);
    </script>
  </head>
  <body>
    <div>
      <form onsubmit="return false">
        <p>大奇門遁甲(Original/founded by Goran FU Chi Leung)</p>
        <table border="0" cellpadding="0" cellspacing="0" width="100%">
          <tr>
            <td colspan="4">
              <input type="text" name="txtDate" style='border:1' />
            </td>
            <td>
              <input type="button" value="當下" onclick="$('#cboDun :nth-child(1)').prop('selected', true);$('#cboKook :nth-child(1)').prop('selected', true);calc_now()" />
            </td>
            <td>
              <input type="button" value="計算" onclick="calc()" />
            </td>
          </tr>
          <tr>
            <script language="JavaScript">
            (function abc() {
              var a = ['年','月','日','時','分','秒'];
              for(var i in a) {
                document.write(
                  sprintf('<td><input type="button" value="+%s" onclick="tuneDate(this)" /></td>',a[i])
                );
              }
            })();
            </script>
          </tr>
          <tr>
            <script language="JavaScript">
            (function abc() {
              var a = ['年','月','日','時','分','秒'];
              for(var i in a) {
                document.write(
                  sprintf('<td><input type="button" value="-%s" onclick="tuneDate(this)" /></td>',a[i])
                );
              }
            })();
            </script>
          </tr>
        </table>
        <div><pre id="info"></pre></div>
        <div>
          <table border="1">
            <tr><td><pre id='ii4'></pre></td><td><pre id='ii9'></pre></td><td><pre id='ii2'></pre></td></tr>
            <tr><td><pre id='ii3'></pre></td><td><pre id='ii5'></pre></td><td><pre id='ii7'></pre></td></tr>
            <tr><td><pre id='ii8'></pre></td><td><pre id='ii1'></pre></td><td><pre id='ii6'></pre></td></tr>
          </table>
        </div>
        <pre style="visibility:hidden" id="tpltable">＋　　　　　｜　　　　｜　　　　　＋
　＋－－－－＋－－－－＋－－－－＋　
　｜　　　　｜　　　　｜　　　　｜　
　｜　　　　｜　　　　｜　　　　｜　
　｜　　　　｜　　　　｜　　　　｜　
　｜　　　　｜　　　　｜　　　　｜　
－＋－－－－＋－－－－＋－－－－＋－
　｜　　　　｜　　　　｜　　　　｜　
　｜　　　　｜　　　　｜　　　　｜　
　｜　　　　｜　　　　｜　　　　｜　
　｜　　　　｜　　　　｜　　　　｜　
－＋－－－－＋－－－－＋－－－－＋－
　｜　　　　｜　　　　｜　　　　｜　
　｜　　　　｜　　　　｜　　　　｜　
　｜　　　　｜　　　　｜　　　　｜　
　｜　　　　｜　　　　｜　　　　｜　
　＋－－－－＋－－－－＋－－－－＋　
＋　　　　　｜　　　　｜　　　　　＋</pre>
      </form>
    </div>
  </body>
</html>